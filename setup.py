#!/usr/bin/env python

# vi:set tabsize=3:
#
# Copyright (C) 2001, 2002 Ichiro Fujinaga, Michael Droettboom,
#                          and Karl MacMillan
#
# This program is free software; you can redistribute it and/or
# modify it under the terms of the GNU General Public License
# as published by the Free Software Foundation; either version 2
# of the License, or (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
# 
# You should have received a copy of the GNU General Public License
# along with this program; if not, write to the Free Software
# Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
#

# This is a total hack to patch up an error in distutils.command.bdist_rpm
import distutils.command.bdist_rpm
def run(self):
   try:
      original_run(self)
   except AssertionError, e:
      if str(e).startswith("unexpected number of RPM files found"):
         rpms = glob.glob(os.path.join(os.path.join(self.rpm_base, 'RPMS'),
                                       "*/*.rpm"))
         for rpm in rpms:
            self.move_file(rpm, self.dist_dir)
      else:
         raise e
original_run = distutils.command.bdist_rpm.bdist_rpm.run
setattr(distutils.command.bdist_rpm.bdist_rpm, 'run', run)

from distutils.core import setup, Extension
from distutils.util import get_platform
from distutils.sysconfig import get_python_lib

import sys, os, glob

# If gamera.generate is imported gamera.__init__.py will
# also be imported, which won't work until the build is
# finished. To get around this, the gamera directory is
# added to the path and generate is imported directly
sys.path.append("gamera")
import generate, gamera_setup

########################################
# Check that this is at least Python 2.2
gamera_setup.check_python_version()

########################################
# Some platforms require extra compile and link arguments
extra_compile_args = []
extra_link_args = []
libraries = []
if sys.platform == 'win32' and not '--compiler=mingw32' in sys.argv:
   extra_compile_args = ["/GR"]#, "/Zi"]
elif sys.platform == 'darwin':
   extra_link_args = ['-F/System/Library/Frameworks/']
elif '--compiler=mingw32' in sys.argv or not sys.platform == 'win32':
   libraries = ["stdc++"] # Not for intel compiler
extras = {'extra_compile_args': extra_compile_args,
          'extra_link_args': extra_link_args,
          'libraries': libraries}

##########################################
# generate the command line startup scripts
command_line_utils = (
   ('gamera_gui', 'gamera_gui.py',
    """#!%(executable)s\n"""
    """%(header)s\n"""
    """import gamera_post_install\n"""
    """print "Loading GAMERA..."\n"""
    """from gamera.gui import gui\n"""
    """gui.run()"""),
   
   ('gamera_cl', 'gamera_cl.py',
    """#!/usr/bin/env sh\n"""
    """%(header)s\n"""
    """import gamera_post_install\n"""
    """print "Loading GAMERA..."\n"""
    """%(executable)s -i -c "from gamera.core import *; init_gamera()"\n"""
    ),
   
   ('gamera_test', 'gamera_test.py',
    """#!%(executable)s\n"""
    """import gamera_post_install"""
    """from gamera import testing\n"""
    """testing.main()"""
    )
   )
if sys.platform == 'win32':
   command_line_filename_at = 1
   scripts_directory_name = "Scripts"
else:
   command_line_filename_at = 0
   scripts_directory_name = "bin/"

scripts = [x[command_line_filename_at] for x in command_line_utils] + ["gamera_post_install.py"]

info = {'executable': sys.executable,
        'header'    :
        """# This file was automatically generated by the\n"""
        """# Gamera setup script on %s.\n""" } #%
for util in command_line_utils:
   if sys.platform == 'win32':
      _, file, content = util
   else:
      file, _, content = util
   fd = open(file, 'w')
   fd.write(content % info)
   fd.close()
os.chmod(file, 0700)

########################################
# Distutils setup

ga_files = glob.glob("src/ga/*.cpp")
ga_files.append("src/knncoremodule.cpp")
graph_files = glob.glob("src/graph/*.cpp")

##########################################
# generate the plugins
plugin_extensions = []
plugins = gamera_setup.get_plugin_filenames('gamera/plugins/')
plugin_extensions = gamera_setup.generate_plugins(
   plugins, "gamera.plugins", 1, **extras)

extensions = [Extension("gamera.gameracore",
                        ["src/gameramodule.cpp",
                         "src/sizeobject.cpp",
                         "src/pointobject.cpp",
                         "src/dimensionsobject.cpp",
                         "src/rectobject.cpp",
                         "src/regionobject.cpp",
                         "src/regionmapobject.cpp",
                         "src/rgbpixelobject.cpp",
                         "src/imagedataobject.cpp",
                         "src/imageobject.cpp",
                         "src/imageinfoobject.cpp"
                         ],
                        include_dirs=["include"],
                        **extras
                        ),
              Extension("gamera.knncore", ga_files,
                        include_dirs=["include", "src/ga", "src"],
                        **extras),
              Extension("gamera.graph", graph_files,
                        include_dirs=["include", "src", "src/graph"],
                        **extras)]
extensions.extend(plugin_extensions)

if sys.platform == "win32":
   description = ("""This is the Gamera installer.\n""" + 
   """Please make sure you have Python 2.2 (or later) and wxPython 2.4.0 \n""" +
   """(or later) installed before proceeding with the installation.  After\n""" +
   """the installer completes, run the 'gamera_post_install' script in\n""" +
   """'Scripts' directory of your Python installation.""")
else:
   description = ("This is the Gamera installer." +
                  "Please ensure that Python 2.2 (or later) and wxPython 2.4.0" +
                  "(or later) are installed before proceeding.")

lib_path = os.path.join(get_python_lib(), 'gamera')

setup(name = "gamera", version="2.1.4",
      url = "http://dkc.jhu.edu/gamera/",
      author = "Michael Droettboom and Karl MacMillan",
      author_email = "mdboom@jhu.edu; karlmac@jhu.edu",
      ext_modules = extensions,
      description = description,
      packages = ['gamera', 'gamera.gui', 'gamera.plugins'],
      data_files=[(os.path.join(lib_path, "test"), glob.glob("gamera/test/*.tiff"))]
      )
